<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>실시간 거래 대시보드</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoAAtc+LyA+6PaSHH3bzqlD2taSXZ8o3bmFf8n5XhIlyQ8w" crossorigin="anonymous">
  <!-- Socket.IO 클라이언트 -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    body { margin: 20px; background-color: #f8f9fa; }
    h1 { margin-bottom: 30px; }
    .table { border-collapse: separate; border-spacing: 0; }
    .table th, .table td { border: 1px solid #dee2e6; text-align: center; vertical-align: middle; }
    .table thead th { background-color: #343a40; color: #fff; }
    .status-connected { color: green; font-weight: bold; }
    .status-disconnected { color: red; font-weight: bold; }
    .row-connected { background-color: #e9f7ef; }
    .row-disconnected { background-color: #fbeeee; }
    .goal-message { position: fixed; top: 20px; right: 20px; z-index: 1000; }
  </style>
</head>
<body>
<div class="container">
  <a href="/logout" class="btn btn-danger mb-3">로그아웃</a>
  <h1 class="text-center">실시간 거래 대시보드</h1>
  <table id="data-table" class="table table-striped table-hover">
    <thead>
      <tr>
        <th>이름</th>
        <th>사용자 IP 주소</th>
        <th>총 자산(투자자금)</th>
        <th>거래 코인</th>
        <th>레버리지 사용량</th>
        <th>현재 포지션 상태</th>
        <th>현재 수익율 </th>
        <th>미실현 손익 </th>
        <th>총 자산 (미실현 손익 포함)</th>
        <th>누적 수익금 </th>
        <th>목표 수익금 (USDT)</th>
        <th>서버 통신 상태</th>
        <th>타임스탬프</th>
        <!-- 기존 승인 관련 항목 -->
        <th>승인</th>
        <th>승인취소</th>
        <th>목표 달성</th>
      </tr>
    </thead>
    <tbody id="data-body">
      <!-- 각 사용자 행은 실시간 업데이트됩니다. -->
    </tbody>
  </table>
</div>
<div id="goal-message-container" class="goal-message"></div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ROAPyY4h6a9kAqV6iEOJq9k6lZPqqvIy3s6eGZKlj/DuCkC8rjCGY3bEhVB0jRiS" crossorigin="anonymous"></script>
<script>
  // 전역 객체: 각 사용자의 목표 수익금 편집 상태 및 입력 값 저장
  const targetProfitEditing = {};    // { username: true/false }
  const targetProfitUserInput = {};    // { username: "입력된 값" }
  
  const socket = io();
  const clientData = {};
  const clientTimeouts = {};
  const TERMINATION_TIMEOUT = 30000; // 30초

  // 소켓 연결 및 초기 데이터 요청
  socket.on('connect', () => {
    console.log('서버에 연결되었습니다.');
    socket.emit('request_initial_data');
  });

  socket.on('initial_data', (allUserData) => {
    console.log('초기 데이터 수신:', allUserData);
    allUserData.forEach(data => {
      clientData[data.name] = data;
    });
    updateTable();
  });

  socket.on('update_user_info', (data) => {
    console.log('사용자 정보 업데이트:', data);
    clientData[data.name] = { ...clientData[data.name], ...data };
    updateTable();
  });

  socket.on('update_target_profit', (data) => {
    const { name, targetProfit } = data;
    if (clientData[name]) {
      clientData[name].target_profit = targetProfit;
      console.log(`목표 수익금 업데이트: ${name} - ${targetProfit} USDT`);
      updateTable();
    }
  });

  socket.on('update_data', (data) => {
    console.log('데이터 업데이트 수신:', data);
    if (!data.timestamp) {
      data.timestamp = new Date().toISOString();
    }
    // 클라이언트에서 편집 중인 목표 수익금 값은 유지
    clientData[data.name] = { ...clientData[data.name], ...data };
    if (clientTimeouts[data.name]) {
      clearTimeout(clientTimeouts[data.name]);
    }
    clientTimeouts[data.name] = setTimeout(() => {
      clientData[data.name].server_status = 'Disconnected';
      clientData[data.name].total_balance = 0;
      clientData[data.name].current_profit_rate = 0;
      clientData[data.name].unrealized_pnl = 0;
      clientData[data.name].current_total_asset = 0;
      clientData[data.name].isApproved = false;
      updateTable();
    }, TERMINATION_TIMEOUT);
    updateTable();
  });

  socket.on('disconnect', () => {
    console.log('서버와의 연결이 끊어졌습니다.');
    Object.keys(clientData).forEach(name => {
      clientData[name].server_status = 'Disconnected';
      clientData[name].total_balance = 0;
      clientData[name].current_profit_rate = 0;
      clientData[name].unrealized_pnl = 0;
      clientData[name].current_total_asset = 0;
      // 승인 상태는 유지 (연결 끊김 시 변경하지 않음)
    });
    updateTable();
  });

  socket.on('update_approval_status', (data) => {
    console.log('승인 상태 업데이트:', data);
    if (clientData[data.name]) {
      clientData[data.name].isApproved = data.isApproved;
      updateTable();
    }
  });

  socket.on('goal_achieved', (data) => {
    const { name } = data;
    console.log(`목표 달성 이벤트: ${name}`);
    sendCommand('cancel_approve', name);
    showGoalAchievedMessage(name);
  });

  socket.on('error', (error) => {
    console.error('Socket error:', error);
    showTemporaryMessage(error.message || '알 수 없는 오류 발생');
  });

  // 주기적으로 update_data 미수신 시 처리
  setInterval(() => {
    const now = Date.now();
    Object.keys(clientData).forEach(name => {
      const client = clientData[name];
      if (client.timestamp) {
        const clientTime = new Date(client.timestamp).getTime();
        if (now - clientTime > TERMINATION_TIMEOUT) {
          client.server_status = 'Disconnected';
          client.total_balance = 0;
          client.current_profit_rate = 0;
          client.unrealized_pnl = 0;
          client.current_total_asset = 0;
          client.isApproved = false;
        }
      }
    });
    updateTable();
  }, 5000);

  // 테이블 업데이트 함수: 서버에서 전달된 모든 정보를 표시합니다.
  function updateTable() {
    const tbody = document.getElementById('data-body');
    tbody.innerHTML = '';
    Object.values(clientData).forEach(data => {
      const row = document.createElement('tr');
      row.classList.add(data.server_status === 'Connected' ? 'row-connected' : 'row-disconnected');

      // 이름
      const nameCell = document.createElement('td');
      nameCell.textContent = data.name || '';
      row.appendChild(nameCell);

      // 사용자 IP 주소
      const ipCell = document.createElement('td');
      ipCell.textContent = data.user_ip || '';
      row.appendChild(ipCell);

      // 총 자산 (USDT)
      const totalBalanceCell = document.createElement('td');
      totalBalanceCell.textContent = data.total_balance != null ? parseFloat(data.total_balance).toLocaleString() : '';
      row.appendChild(totalBalanceCell);
      
      // 거래 코인 이름
      const coinCell = document.createElement('td');
      // data.coin 필드에 거래 코인 이름이 있다고 가정 (예: 'BTCUSDT')
      coinCell.textContent = data.coin || '';
      row.appendChild(coinCell);

      // 레버리지 사용량
      const leverageCell = document.createElement('td');
      // data.leverage 필드에 값이 있다고 가정 (예: 20)
      leverageCell.textContent = data.leverage ? data.leverage + '배' : '';
      row.appendChild(leverageCell);

      // 현재 포지션 상태 (예: '롱', '숏', '없음')
      const positionCell = document.createElement('td');
      if (data.position) {
        if (data.position === 'LONG') {
          positionCell.textContent = 'LONG';
          positionCell.style.color = 'green';
        } else if (data.position === 'SHORT') {
          positionCell.textContent = 'SHORT';
          positionCell.style.color = 'red';
        } else {
          positionCell.textContent = '없음';
          positionCell.style.color = 'black';
        }
      } else {
        positionCell.textContent = '없음';
        positionCell.style.color = 'black';
      }
      row.appendChild(positionCell);

      // 현재 수익율 (%)
      const profitRateCell = document.createElement('td');
      profitRateCell.textContent = data.current_profit_rate != null ? parseFloat(data.current_profit_rate).toFixed(2) + '%' : '';
      row.appendChild(profitRateCell);

      // 미실현 손익 (USDT)
      const unrealizedPnlCell = document.createElement('td');
      unrealizedPnlCell.textContent = data.unrealized_pnl != null ? parseFloat(data.unrealized_pnl).toLocaleString() : '';
      row.appendChild(unrealizedPnlCell);

      // 총 자산 (미실현 손익 포함) (USDT)
      const totalWithPnlCell = document.createElement('td');
      totalWithPnlCell.textContent = data.current_total_asset != null ? parseFloat(data.current_total_asset).toLocaleString() : '';
      row.appendChild(totalWithPnlCell);

      // 누적 수익금 (USDT)
      const profitCell = document.createElement('td');
      profitCell.textContent = data.display_profit != null ? parseFloat(data.display_profit).toLocaleString() : '';
      row.appendChild(profitCell);

      // 목표 수익금 (USDT) - 입력 필드 및 Set 버튼
      const targetProfitCell = document.createElement('td');
      let currentValue = data.target_profit != null ? parseFloat(data.target_profit).toFixed(2) : '500';
      if (targetProfitEditing[data.name] && targetProfitUserInput[data.name] !== undefined) {
        currentValue = targetProfitUserInput[data.name];
      }
      const targetProfitInput = document.createElement('input');
      targetProfitInput.type = 'number';
      targetProfitInput.min = '0';
      targetProfitInput.step = '0.01';
      targetProfitInput.value = currentValue;
      targetProfitInput.classList.add('form-control', 'form-control-sm');
      targetProfitInput.style.width = '100px';
      targetProfitInput.id = `target-profit-${data.name}`;
      targetProfitInput.addEventListener('focus', () => { targetProfitEditing[data.name] = true; });
      targetProfitInput.addEventListener('input', (event) => { targetProfitUserInput[data.name] = event.target.value; });
      targetProfitCell.appendChild(targetProfitInput);
      const setButton = document.createElement('button');
      setButton.textContent = 'Set';
      setButton.classList.add('btn', 'btn-primary', 'btn-sm', 'mt-1');
      setButton.onclick = () => setTargetProfit(data.name);
      targetProfitCell.appendChild(setButton);
      row.appendChild(targetProfitCell);

      // 서버 통신 상태
      const serverStatusCell = document.createElement('td');
      serverStatusCell.textContent = data.server_status || '';
      serverStatusCell.classList.add(data.server_status === 'Connected' ? 'status-connected' : 'status-disconnected');
      row.appendChild(serverStatusCell);

      // 타임스탬프
      const timestampCell = document.createElement('td');
      timestampCell.textContent = data.timestamp || '';
      row.appendChild(timestampCell);

      // ----------------- 추가된 항목들 -----------------
      

      // 승인 버튼
      const approveCell = document.createElement('td');
      const approveButton = document.createElement('button');
      approveButton.textContent = '승인';
      approveButton.classList.add('btn', 'btn-success', 'btn-sm');
      approveButton.onclick = () => sendCommand('approve', data.name);
      approveButton.disabled = data.isApproved;
      approveCell.appendChild(approveButton);
      row.appendChild(approveCell);

      // 승인취소 버튼
      const cancelApproveCell = document.createElement('td');
      const cancelApproveButton = document.createElement('button');
      cancelApproveButton.textContent = '승인취소';
      cancelApproveButton.classList.add('btn', 'btn-warning', 'btn-sm');
      cancelApproveButton.onclick = () => sendCommand('cancel_approve', data.name);
      cancelApproveButton.disabled = !data.isApproved;
      cancelApproveButton.id = `cancel-approve-${data.name}`;
      cancelApproveCell.appendChild(cancelApproveButton);
      row.appendChild(cancelApproveCell);

      // 목표 달성 여부
      const goalAchievedCell = document.createElement('td');
      if (data.display_profit >= data.target_profit) {
        goalAchievedCell.textContent = '목표를 달성했습니다';
        goalAchievedCell.classList.add('text-success', 'fw-bold');
      } else {
        goalAchievedCell.textContent = '';
      }
      row.appendChild(goalAchievedCell);

      tbody.appendChild(row);
    });
  }

  function sendCommand(command, clientName) {
    socket.emit('send_command', { command: command, name: clientName });
    console.log(`명령 전송: ${command} - ${clientName}`);
  }

  function setTargetProfit(clientName) {
    const input = document.getElementById(`target-profit-${clientName}`);
    const targetProfit = parseFloat(input.value);
    if (isNaN(targetProfit) || targetProfit <= 0) {
      alert('유효한 목표 수익금을 입력하세요.');
      return;
    }
    // 목표 수익금 설정 시 편집 플래그 해제 및 서버 전송
    socket.emit('set_target_profit', { name: clientName, targetProfit: targetProfit, editingTargetProfit: false });
    console.log(`목표 수익금 설정: ${clientName} - ${targetProfit} USDT`);
    targetProfitEditing[clientName] = false;
    targetProfitUserInput[clientName] = undefined;
    showTemporaryMessage(`${clientName}의 목표 수익금이 ${targetProfit.toLocaleString()} USDT로 설정되었습니다.`);
  }

  function showTemporaryMessage(message) {
    const container = document.getElementById('goal-message-container');
    const alertDiv = document.createElement('div');
    alertDiv.classList.add('alert', 'alert-info', 'alert-dismissible', 'fade', 'show');
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `<strong>알림:</strong> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    container.appendChild(alertDiv);
    setTimeout(() => { bootstrap.Alert.getOrCreateInstance(alertDiv).close(); }, 5000);
  }

  function showGoalAchievedMessage(name, message = '목표를 달성했습니다.') {
    const container = document.getElementById('goal-message-container');
    const alertDiv = document.createElement('div');
    alertDiv.classList.add('alert', 'alert-success', 'alert-dismissible', 'fade', 'show');
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `<strong>${name}:</strong> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    container.appendChild(alertDiv);
    setTimeout(() => { bootstrap.Alert.getOrCreateInstance(alertDiv).close(); }, 5000);
  }
</script>
</body>
</html>
